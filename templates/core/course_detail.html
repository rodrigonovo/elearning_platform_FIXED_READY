{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h1 class="mb-3">{{ course.title }}</h1>
            <p class="lead">{{ course.description }}</p>

            <hr>
            
            {% if user.is_authenticated and user == course.teacher %}
                <a href="{% url 'core:edit_course' pk=course.id %}" class="btn btn-primary mb-4">Edit Course</a>
                <a href="{% url 'core:add_course_material' course_id=course.id %}" class="btn btn-success mb-4">Add Material</a>
            {% endif %}

            {% if user.is_authenticated and user.role == 'student' and is_enrolled %}
                <h2>Course Materials</h2>
                {% if course_materials %}
                    <ul class="list-group mb-4">
                        {% for material in course_materials %}
                            <li class="list-group-item">
                                <a href="{{ material.file.url }}" target="_blank">
                                    {{ material.file.name|split:'/'|last }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No materials have been added to this course yet.</p>
                {% endif %}
            {% endif %}

            {% if user.is_authenticated and user.role == 'teacher' and user == course.teacher %}
                <h2>Enrolled Students</h2>
                {% if course.enrollment_set.all %}
                    <ul class="list-group mb-4">
                        {% for enrollment in course.enrollment_set.all %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="{% url 'core:user_profile' username=enrollment.student.username %}">
                                    {{ enrollment.student.get_full_name }} ({{ enrollment.student.username }})
                                </a>
                                {% if not enrollment.is_blocked %}
                                    <a href="{% url 'core:block_student' course_id=course.id student_id=enrollment.student.id %}" class="btn btn-sm btn-warning">Block</a>
                                {% else %}
                                    <span class="badge bg-danger">Blocked</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No students have enrolled in this course yet.</p>
                {% endif %}
            {% endif %}
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    Course Information
                </div>
                <div class="card-body">
                    <p><strong>Teacher:</strong> <a href="{% url 'core:user_profile' username=course.teacher.username %}">{{ course.teacher.get_full_name }}</a></p>
                    <p><strong>Created on:</strong> {{ course.created_at|date:"F d, Y" }}</p>
                    
                    {% if user.is_authenticated and user.role == 'student' and not is_enrolled %}
                        <a href="{% url 'core:enroll_in_course' course_id=course.id %}" class="btn btn-primary btn-block">Enroll in this course</a>
                    {% endif %}

                    {% if user.is_authenticated and user.role == 'student' and is_enrolled %}
                        {% if not has_submitted_feedback %}
                            <a href="{% url 'core:submit_feedback' course_id=course.id %}" class="btn btn-success btn-block">Submit Feedback</a>
                        {% else %}
                            <p class="text-success mt-2">You have already submitted feedback for this course.</p>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            {% if course.feedback_set.all %}
            <div class="card mt-4">
                <div class="card-header">
                    Feedback & Ratings
                </div>
                <ul class="list-group list-group-flush">
                    {% for feedback in course.feedback_set.all %}
                    <li class="list-group-item">
                        <strong>{{ feedback.student.get_full_name }}:</strong>
                        <p>{{ feedback.comment }}</p>
                        <small class="text-muted">Rating: {{ feedback.rating }}/5</small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}